<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OPCG Sandbox - Live Mirror V2</title>
    <style>
        :root { --card-w: 75px; --card-h: 105px; --leader-w: 100px; --leader-h: 140px; --don-w: 60px; --don-h: 84px; --side-w: 250px; --op-blue: #0088cc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #080808; color: #f0f0f0; margin: 0; overflow: hidden; height: 100vh; width: 100vw; display: flex; user-select: none; }
        
        #sidebar { width: var(--side-w); background: #111; border-right: 2px solid #333; display: flex; flex-direction: column; padding: 15px; gap: 8px; z-index: 100; box-sizing: border-box; overflow-y: auto; }
        #viewport { flex-grow: 1; position: relative; background: #0c0c0c; overflow-y: auto; z-index: 1; display: flex; flex-direction: column; gap: 10px; padding: 10px; box-sizing: border-box; padding-bottom: 150px; }
        
        .board-section { display: grid; grid-template-columns: 80px 120px 1fr 80px; gap: 8px; background: #151515; padding: 10px; border-radius: 12px; border: 2px solid #222; position: relative; }
        
        /* PLAYER LAYOUT (Front Line at Top) */
        #my-board { grid-template-rows: auto auto auto; }
        #my-board .char-zone { grid-row: 1; }
        #my-board .stage-zone { grid-row: 2; }
        #my-board .don-zone { grid-row: 3; }
        #my-board .leader-zone { grid-row: 1 / 3; }
        #my-board .life-zone { grid-row: 1 / 3; }
        #my-board .don-deck { grid-row: 3; }

        /* OPPONENT LAYOUT (Flipped: Front Line at Bottom) */
        #opp-board { grid-template-rows: auto auto auto; border-color: #c0392b; }
        #opp-board .don-zone { grid-row: 1; }
        #opp-board .stage-zone { grid-row: 2; }
        #opp-board .char-zone { grid-row: 3; }
        #opp-board .leader-zone { grid-row: 2 / 4; }
        #opp-board .life-zone { grid-row: 2 / 4; }
        #opp-board .don-deck { grid-row: 1; }
        #opp-board .card { pointer-events: none; }

        .slot { border: 2px dashed #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #666; font-size: 10px; text-transform: uppercase; text-align: center; flex-direction: column; position: relative; min-height: var(--card-h); }
        .flex-zone { display: flex; gap: 8px; padding: 8px; justify-content: flex-start; align-items: center; border: 2px dashed #333; border-radius: 8px; position: relative; flex-wrap: wrap; min-height: 100px; }
        .flex-zone::after { content: attr(data-label); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #222; font-size: 20px; font-weight: bold; text-transform: uppercase; z-index: 0; pointer-events: none; }

        /* Card Visuals */
        .card { width: var(--card-w); height: var(--card-h); position: absolute; background-size: 100% 100%; border-radius: 6px; cursor: grab; border: 1px solid #000; box-shadow: 0 4px 8px rgba(0,0,0,0.5); z-index: 20; transition: transform 0.2s ease, filter 0.2s; background-color: #222; }
        .leader-zone .card { width: var(--leader-w); height: var(--leader-h); }
        .flex-zone .card, #hand-bar .card { position: relative !important; left: 0 !important; top: 0 !important; z-index: 10 !important; flex-shrink: 0; }
        .card.rested { transform: rotate(90deg); filter: brightness(0.6); }
        .card-back { background-image: url('https://m.media-amazon.com/images/I/51xnq29+enL._AC_.jpg') !important; color: transparent !important; }

        .don-badge, .power-badge, .rush-tag { position: absolute; border: 2px solid #000; display: none; align-items: center; justify-content: center; font-weight: 900; pointer-events: none; }
        .don-badge { bottom: -8px; right: -8px; background: #ffcc00; color: #000; width: 24px; height: 24px; border-radius: 50%; z-index: 41; font-size: 11px;}
        .power-badge { top: -10px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; z-index: 41; }
        .rush-tag { top: 50%; left: 50%; transform: translate(-50%, -50%); background: #f39c12; color: black; padding: 2px; border-radius: 4px; font-size: 12px; z-index: 45; }

        #hand-bar { position: absolute; bottom: 0; left: var(--side-w); right: 0; height: 130px; background: rgba(10,10,10,0.98); border-top: 2px solid var(--op-blue); display: flex; align-items: center; padding: 0 20px; gap: 8px; z-index: 80; overflow-x: auto; }
        button { background: #333; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        .stat-card { background: #000; padding: 8px; border-radius: 6px; border: 1px solid #222; text-align: center; font-size: 12px; font-weight: bold; }
        
        #context-menu { position: absolute; display: none; background: #1a1a1a; border: 1px solid #444; z-index: 999999; border-radius: 4px; width: 160px; box-shadow: 0 10px 20px rgba(0,0,0,0.8); overflow: hidden;}
        #context-menu div { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #222; font-size: 11px; }
        #context-menu div:hover { background: var(--op-blue); }

        #home-screen { position: fixed; inset: 0; background: #000; z-index: 999999; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 20px;}
        .menu-box { background:#1a1a1a; padding:30px; border-radius:12px; border:1px solid #333; width:450px; text-align: center;}
        #zoom-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999999; display: none; align-items: center; justify-content: center; cursor: pointer; }
        #zoom-img { height: 75vh; max-width: 90vw; object-fit: contain; border: 4px solid var(--op-blue); border-radius: 15px; }
    </style>
</head>
<body>

<div id="home-screen">
    <div class="menu-box" id="menu-main">
        <h2 style="color:var(--op-blue);">OPCG Multiplayer</h2>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="createLobby()" style="flex:1; background:#2ecc71;">CREATE LOBBY</button>
            <button onclick="showJoinLobby()" style="flex:1; background:#e67e22;">JOIN LOBBY</button>
        </div>
    </div>
    <div class="menu-box" id="menu-join" style="display:none;">
        <input type="text" id="room-code-input" placeholder="ENTER 4-LETTER CODE" style="width:80%; padding:10px; background:#000; color:#fff; border:1px solid #444; text-transform:uppercase;">
        <button onclick="joinLobby()" style="width:80%; margin-top:10px; background:#e67e22;">JOIN</button>
    </div>
    <div class="menu-box" id="menu-deck" style="display:none;">
        <h2>Lobby: <span id="display-room-code" style="color:#e74c3c;">----</span></h2>
        <p id="lobby-status">Waiting...</p>
        <button onclick="selectDeck('Franky')" id="btn-select-franky" disabled>SELECT FRANKY DECK</button>
    </div>
</div>

<div id="sidebar">
    <div class="stat-card" style="background:#2c3e50; color:#fff;">OPP DON!!: <span id="opp-don">0</span></div>
    <div class="stat-card">DECK: <span id="deck-count">0</span> | TRASH: <span id="trash-count">0</span></div>
    <div class="stat-card" style="border-color:#e74c3c;">LIFE: <span id="life-count">0</span></div>
    <button onclick="endTurn()" style="background:#2980b9; height: 50px;">END TURN</button>
    <button onclick="spawnDon()">+ DON!!</button>
    <button onclick="killDon()" style="background:#e67e22">- DON!!</button>
</div>

<div id="viewport">
    <div id="opp-board" class="board-section">
        <div id="opp-don-deck" class="slot don-deck card-back"></div>
        <div id="opp-don-zone" class="flex-zone don-zone" data-label="Cost Area"></div>
        <div id="opp-stage-zone" class="flex-zone stage-zone" data-label="Stage Area"></div>
        <div id="opp-char-zone-front" class="flex-zone char-zone" data-label="Front Line"></div>
        <div id="opp-leader-zone" class="slot leader-zone">Leader</div>
        <div id="opp-life-zone" class="slot life-zone">Life</div>
        <div id="opp-drop-trash" class="slot">Trash</div>
    </div>

    <div id="my-board" class="board-section">
        <div id="life-zone" class="slot life-zone">Life</div>
        <div id="leader-zone" class="slot leader-zone">Leader</div>
        <div id="char-zone-front" class="flex-zone char-zone" data-label="Front Line"></div>
        <div id="stage-zone" class="flex-zone stage-zone" data-label="Stage Area"></div>
        <div id="don-deck" class="slot don-deck card-back"></div>
        <div id="don-zone" class="flex-zone don-zone" data-label="Cost Area"></div>
        <div id="drop-trash" class="slot">Trash</div>
    </div>
</div>

<div id="hand-bar"></div>
<div id="context-menu"></div>
<div id="zoom-overlay" onclick="this.style.display='none'"><img id="zoom-img"></div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    const DON_URL = 'https://tcgplayer-cdn.tcgplayer.com/product/456059_in_1000x1000.jpg';
    let DECK_ARR = [], TRASH_ARR = [], DON_DECK_COUNT = 10, OPP_DON = 0, turnNum = 1, isFirst = true;
    let dragged = null, cardIDCounter = 0, isDragging = false, offX, offY, startX, startY, rightClickedCard;

    const CARD_DB = {
        "https://i.imgur.com/llnj5xT.png": { name: "Franky", type: "Leader" },
        "https://i.imgur.com/2lEVHJP.png": { name: "Franky (Char)", type: "Character", cost: 1, hasOnPlay: true },
        "https://i.imgur.com/zmZCFVB.png": { name: "General Franky", type: "Character", cost: 11 }
    };

    // ==========================================
    // SYNC LOGIC (The "Live" Part)
    // ==========================================
    function saveState() {
        const field = Array.from(document.querySelectorAll('#my-board .card')).map(c => ({
            id: c.id, url: c.dataset.url, zone: c.parentElement.id,
            rested: c.classList.contains('rested'), back: c.classList.contains('card-back'),
            power: c.querySelector('.power-badge').innerText, 
            pVis: c.querySelector('.power-badge').style.display,
            rush: c.querySelector('.rush-tag').style.display
        }));
        
        socket.emit('board_update', {
            deck: DECK_ARR.length, don: DON_DECK_COUNT,
            oppActiveDon: document.querySelectorAll('#don-zone .card:not(.rested)').length,
            field, handCount: document.querySelectorAll('#hand-bar .card').length
        });
        refreshStats();
    }

    socket.on('opponent_board_update', (s) => {
        document.querySelectorAll('#opp-board .card').forEach(c => c.remove());
        s.field.forEach(d => {
            const map = {"char-zone-front":"opp-char-zone-front", "stage-zone":"opp-stage-zone", "leader-zone":"opp-leader-zone", "don-zone":"opp-don-zone", "life-zone":"opp-life-zone", "drop-trash":"opp-drop-trash"};
            const target = document.getElementById(map[d.zone]);
            if(target) {
                const c = createCard(d.url, 0, 0, { isOpponent: true, isBack: d.back, id: 'opp-'+d.id });
                if(d.rested) c.classList.add('rested');
                c.querySelector('.power-badge').innerText = d.power;
                c.querySelector('.power-badge').style.display = d.pVis;
                target.appendChild(c);
                if(d.zone === "life-zone") { c.style.position = 'absolute'; c.style.top = (target.querySelectorAll('.card').length * 20) + 'px'; }
            }
        });
        document.getElementById('opp-don').innerText = s.oppActiveDon;
    });

    // ==========================================
    // INTERACTION HOOKS
    // ==========================================
    window.addEventListener('mouseup', (e) => {
        if (!dragged) return;
        const c = dragged; dragged = null;
        if (!isDragging) return;
        
        // Handle drop logic here (simplified for this example)
        const zones = ['life-zone', 'leader-zone', 'char-zone-front', 'stage-zone', 'don-zone', 'drop-trash'];
        const target = zones.map(z => document.getElementById(z)).find(el => isInside(e, el.getBoundingClientRect()));
        
        if (target) { target.appendChild(c); c.style.position = (target.id === 'life-zone') ? 'absolute' : 'relative'; }
        saveState(); // Sync after move
    });

    function restCard(c) { c.classList.toggle('rested'); saveState(); }
    window.setPower = (v) => { 
        const p = rightClickedCard.querySelector('.power-badge');
        if(v===0) { p.style.display='none'; p.innerText='+0'; } 
        else { p.style.display='flex'; p.innerText = `+${parseInt(p.innerText)+v}`; }
        saveState(); hideMenu(); 
    };

    // ==========================================
    // MULTIPLAYER SETUP
    // ==========================================
    function createLobby() { socket.emit('create_room', (res) => { document.getElementById('menu-main').style.display='none'; document.getElementById('menu-deck').style.display='block'; document.getElementById('display-room-code').innerText=res.roomId; }); }
    function showJoinLobby() { document.getElementById('menu-main').style.display='none'; document.getElementById('menu-join').style.display='block'; }
    function joinLobby() { socket.emit('join_room', document.getElementById('room-code-input').value.toUpperCase(), (res) => { if(res.success) { document.getElementById('menu-join').style.display='none'; document.getElementById('menu-deck').style.display='block'; } }); }
    socket.on('player_joined', () => { document.getElementById('lobby-status').innerText = "Opponent Joined!"; document.getElementById('btn-select-franky').disabled = false; });
    function selectDeck() { socket.emit('deck_selected'); }
    socket.on('game_start', (d) => { document.getElementById('home-screen').style.display='none'; initBoard(); });

    // ==========================================
    // HELPERS
    // ==========================================
    function initBoard() { createCard("https://i.imgur.com/llnj5xT.png", 0, 0, {zone:'leader-zone'}); saveState(); }
    function createCard(url, x, y, opts={}) {
        const c = document.createElement('div'); c.className = 'card'; c.id = opts.id || 'c-'+cardIDCounter++;
        c.dataset.url = url; c.style.backgroundImage = `url('${url}')`;
        c.innerHTML = `<div class="power-badge">+0</div><div class="rush-tag">RUSH</div>`;
        if(!opts.isOpponent) {
            c.onmousedown = (e) => { if(e.button===0) { dragged = c; isDragging=false; startX=e.clientX; startY=e.clientY; }};
            c.oncontextmenu = (e) => { e.preventDefault(); rightClickedCard=c; showMenu(e); };
        }
        if(opts.zone) document.getElementById(opts.zone).appendChild(c);
        return c;
    }
    function isInside(e, r) { return e.clientX > r.left && e.clientX < r.right && e.clientY > r.top && e.clientY < r.bottom; }
    function showMenu(e) { const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; m.innerHTML=`<div onclick="restCard(rightClickedCard)">Rest/Unrest</div><div onclick="setPower(1000)">+1000 Power</div><div onclick="setPower(0)">Reset</div>`; }
    function hideMenu() { document.getElementById('context-menu').style.display='none'; }
    function refreshStats() { document.getElementById('deck-count').innerText=DECK_ARR.length; document.getElementById('life-count').innerText=document.querySelectorAll('#life-zone .card').length; }
    window.spawnDon = () => { if(DON_DECK_COUNT>0) { DON_DECK_COUNT--; createCard(DON_URL,0,0,{zone:'don-zone'}); saveState(); } };
    window.killDon = () => { const d = document.querySelector('#don-zone .card'); if(d) { d.remove(); DON_DECK_COUNT++; saveState(); } };
</script>
</body>
</html>
