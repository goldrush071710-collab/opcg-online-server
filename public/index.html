// ... (Keep your CARD_DB and deckArray at the top)

// REPLACED SYNC LOGIC FOR MIRRORING
socket.on('opponent_board_update', (s) => {
    // 1. Clear ONLY the opponent's physical cards from the top board
    document.querySelectorAll('#opp-board .card').forEach(c => c.remove());
    
    // 2. Sync Stats
    document.getElementById('opp-hand-count').innerText = s.handCount;
    document.getElementById('opp-deck-count').innerText = s.deck;
    document.getElementById('opp-don').innerText = s.oppActiveDon;

    // 3. Render Opponent's Cards into Top Zones
    s.field.forEach(cardData => {
        // Map Player zones to Opponent zones
        let targetZoneId = "";
        const z = cardData.zone;

        if (z === "char-zone-front") targetZoneId = "opp-char-zone-front";
        else if (z === "stage-zone") targetZoneId = "opp-stage-zone";
        else if (z === "leader-zone") targetZoneId = "opp-leader-zone";
        else if (z === "don-zone") targetZoneId = "opp-don-zone";
        else if (z === "life-zone") targetZoneId = "opp-life-zone";
        else if (z === "drop-trash") targetZoneId = "opp-drop-trash";
        
        const targetZone = document.getElementById(targetZoneId);
        if (targetZone) {
            const c = createCard(cardData.url, 0, 0, { 
                isOpponent: true, 
                isBack: cardData.back, 
                id: 'opp-' + cardData.id 
            });
            
            if (cardData.rested) c.classList.add('rested');
            
            // Handle Life Stacking
            if (z === "life-zone") {
                c.style.position = "absolute";
                c.style.top = (targetZone.children.length * 20) + "px";
            }

            targetZone.appendChild(c);
            
            // Sync Power/Rush badges
            const pBadge = c.querySelector('.power-badge');
            pBadge.innerText = cardData.power;
            pBadge.style.display = cardData.pVis;
            c.querySelector('.rush-tag').style.display = cardData.rush;
        }
    });
});

// TRIGGER SYNC ON EVERY MOVE
function saveState() {
    // ... (Keep your existing historyStack logic)
    
    const field = Array.from(document.querySelectorAll('#my-board .card')).map(c => ({
        id: c.id, url: c.dataset.url, zone: c.parentElement.id, 
        isDon: c.dataset.isDon, isLife: c.dataset.isLife, 
        rested: c.classList.contains('rested'), back: c.classList.contains('card-back'),
        power: c.querySelector('.power-badge').innerText, 
        pVis: c.querySelector('.power-badge').style.display, 
        rush: c.querySelector('.rush-tag').style.display
    }));

    const activeDonCount = document.querySelectorAll('#don-zone .card:not(.rested)').length;
    
    // Send to Opponent
    socket.emit('board_update', { 
        deck: DECK_ARR.length, 
        trash: TRASH_ARR.length, 
        don: DON_DECK_COUNT, 
        oppActiveDon: activeDonCount, 
        field: field, 
        handCount: document.querySelectorAll('#hand-bar .card').length 
    });
    
    refreshStats();
}
