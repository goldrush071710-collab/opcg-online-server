<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OPCG Sandbox - Master Engine V7</title>
    <style>
        :root { --card-w: 105px; --card-h: 147px; --don-w: 85px; --don-h: 119px; --side-w: 280px; --op-blue: #0088cc; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #0c0c0c; color: #f0f0f0; margin: 0; overflow: hidden; height: 100vh; width: 100vw; display: flex; user-select: none; }
        
        #sidebar { width: var(--side-w); background: #151515; border-right: 2px solid #333; display: flex; flex-direction: column; padding: 15px; gap: 8px; z-index: 100; box-sizing: border-box; overflow-y: auto; }
        #viewport { flex-grow: 1; position: relative; background: #0f0f0f; overflow: hidden; z-index: 1; display: grid; grid-template-columns: 120px 1fr 120px; grid-template-rows: auto auto 1fr; gap: 15px; padding: 20px; box-sizing: border-box; padding-bottom: 180px; }
        
        .slot { border: 2px dashed #333; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #555; font-size: 11px; text-transform: uppercase; text-align: center; flex-direction: column; position: relative; min-height: var(--card-h); }
        .flex-zone { display: flex; gap: 10px; padding: 10px; justify-content: flex-start; align-items: center; border: 2px dashed #222; border-radius: 10px; position: relative; flex-wrap: wrap; min-height: calc(var(--card-h) + 20px); }
        .flex-zone::after { content: attr(data-label); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #222; font-size: 24px; font-weight: bold; text-transform: uppercase; z-index: 0; pointer-events: none; }

        /* Specific Zones */
        #life-zone { grid-column: 1; grid-row: 1 / 3; border-color: #e74c3c; width: var(--card-w); align-self: start; height: calc(var(--card-h) + 180px); position: relative; }
        #don-deck { grid-column: 1; grid-row: 3; border-color: #ffcc00; background-image: url('https://tcgplayer-cdn.tcgplayer.com/product/456059_in_1000x1000.jpg'); background-size: 100% 100%; color: white; text-shadow: 1px 1px 2px black; font-weight: bold; font-size: 14px; width: var(--card-w); height: var(--card-h);}
        
        #char-zone-front { grid-column: 2; grid-row: 1; border-color: #2ecc71; }
        #stage-zone { grid-column: 2; grid-row: 2; border-color: #9b59b6; }
        #leader-zone { grid-column: 3; grid-row: 2; border-color: var(--op-blue); width: var(--card-w); height: var(--card-h); }
        #drop-deck { grid-column: 3; grid-row: 1; background-image: url('https://m.media-amazon.com/images/I/51xnq29+enL._AC_.jpg'); background-size: 100% 100%; cursor: pointer; border-color: #666; color: white; text-shadow: 1px 1px 2px black; font-weight: bold; width: var(--card-w); height: var(--card-h);}
        #drop-trash { grid-column: 3; grid-row: 3; width: var(--card-w); height: var(--card-h); border-color: #7f8c8d; cursor: pointer; z-index: 50; }
        #don-zone { grid-column: 2; grid-row: 3; border-color: #ffcc00; }

        /* Card Styles */
        .card { width: var(--card-w); height: var(--card-h); position: absolute; background-size: 100% 100%; border-radius: 8px; cursor: grab; border: 1px solid #000; box-shadow: 0 4px 8px rgba(0,0,0,0.5); z-index: 20; transition: transform 0.2s ease, filter 0.2s; background-color: #222; }
        .flex-zone .card, #hand-bar .card { position: relative !important; left: 0 !important; top: 0 !important; z-index: 10 !important; flex-shrink: 0; }
        #hand-bar .card { cursor: pointer; }
        #life-zone .card { position: absolute !important; cursor: grab; z-index: 20;}
        
        .card[data-is-don="true"] { width: var(--don-w); height: var(--don-h); cursor: grab !important; }
        .card.rested { transform: rotate(90deg); filter: brightness(0.6); }
        .card-back { background-image: url('https://m.media-amazon.com/images/I/51xnq29+enL._AC_.jpg') !important; color: transparent !important; }

        .don-badge, .power-badge, .rush-tag { position: absolute; border: 2px solid #000; display: none; align-items: center; justify-content: center; font-weight: 900; pointer-events: none; }
        .don-badge { bottom: -8px; right: -8px; background: #ffcc00; color: #000; width: 28px; height: 28px; border-radius: 50%; z-index: 41; }
        .power-badge { top: -10px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 2px 8px; border-radius: 4px; font-size: 12px; z-index: 41; }
        .rush-tag { top: 50%; left: 50%; transform: translate(-50%, -50%); background: #f39c12; color: black; padding: 4px; border-radius: 4px; font-size: 14px; z-index: 45; }

        #hand-bar { position: absolute; bottom: 0; left: var(--side-w); right: 0; height: 160px; background: rgba(10,10,10,0.98); border-top: 2px solid var(--op-blue); display: flex; align-items: center; padding: 0 20px; gap: 10px; z-index: 80; overflow-x: auto; }

        button { background: #333; color: white; border: 1px solid #444; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 11px; font-weight: bold; transition: 0.2s; }
        button:hover { background: var(--op-blue); }
        .stat-card { background: #000; padding: 8px; border-radius: 6px; border: 1px solid #222; text-align: center; font-size: 12px; font-weight: bold; }
        
        #context-menu { position: absolute; display: none; background: #1a1a1a; border: 1px solid #444; z-index: 999999; border-radius: 4px; width: 180px; box-shadow: 0 10px 20px rgba(0,0,0,0.8); overflow: hidden;}
        #context-menu div { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #222; font-size: 12px; }
        #context-menu div:hover { background: var(--op-blue); }

        #home-screen { position: fixed; inset: 0; background: #000; z-index: 999999; display: flex; align-items: center; justify-content: center; }
        #inspector { position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 100000; display: none; padding: 50px; overflow-y: auto; pointer-events: auto;}
        #zoom-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999999; display: none; align-items: center; justify-content: center; cursor: pointer; }
        #zoom-img { height: 75vh; max-width: 90vw; object-fit: contain; border: 4px solid var(--op-blue); border-radius: 15px; }
        
        #select-overlay { position: fixed; inset: 0; background: rgba(200,0,0,0.2); z-index: 89999; display: none; pointer-events: none; }
        #select-msg { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: #e74c3c; padding: 15px 30px; font-size: 20px; font-weight: bold; border-radius: 10px; z-index: 90000; display: flex; align-items: center; gap: 20px; pointer-events: auto;}
        body.select-mode { cursor: crosshair !important; }
        body.select-mode .card { outline: 3px dashed #ffcc00; cursor: crosshair !important; pointer-events: auto !important; }
        body.select-mode #hand-bar { z-index: 90005; } 
    </style>
</head>
<body>

<div id="home-screen">
    <div style="background:#1a1a1a; padding:30px; border-radius:12px; border:1px solid #333; width:450px;">
        <h2 style="margin-top:0; color:var(--op-blue); text-align:center;">OPCG Sandbox Engine</h2>
        <div id="deck-list" style="margin-top:10px; max-height:250px; overflow-y:auto;"></div>
    </div>
</div>

<div id="select-overlay"></div>
<div id="select-msg"><span id="select-text">SELECT A TARGET</span> <button onclick="cancelSelection()" style="background:#c0392b; border:1px solid #fff;">CANCEL</button></div>

<div id="sidebar">
    <div style="display:flex; gap:5px; margin-bottom: 10px;">
        <button onclick="undoState()" style="flex:1; background:#555;">UNDO</button>
        <button onclick="redoState()" style="flex:1; background:#555;">REDO</button>
    </div>
    
    <div class="stat-card" style="background:#2c3e50; margin-bottom:5px; color:#fff;">OPP DON!!: <span id="opp-don">0</span></div>
    
    <div style="display:flex; gap:5px;">
        <div class="stat-card" style="flex:1; cursor:pointer;" onclick="openInspector('deck')">DECK: <span id="deck-count">0</span></div>
        <div class="stat-card" style="flex:1; cursor:pointer;" onclick="openInspector('trash')">TRASH: <span id="trash-count">0</span></div>
    </div>
    <div class="stat-card" style="border-color:#e74c3c; margin-bottom: 5px;">LIFE: <span id="life-count">0</span></div>
    
    <button onclick="deckToLife()" style="background:#e74c3c; margin-bottom: 5px;">+1 LIFE FROM DECK</button>
    <button onclick="resetOncePerGame()" style="background:#8e44ad; border-color:#fff;">RESET ONCE PER GAME</button>
    <hr style="width:100%; border:0; border-top:1px solid #333;">
    
    <button onclick="endTurn()" style="background:#2980b9; height: 50px;">END TURN</button>
    <div style="display:flex; gap:5px; margin-top:5px;">
        <button onclick="spawnDon()" style="flex:1">+ DON!!</button>
        <button onclick="killDon()" style="flex:1; background:#e67e22">- DON!!</button>
    </div>
    <button onclick="location.reload()" style="background:#8b0000; margin-top:10px;">QUIT TO MENU</button>
</div>

<div id="viewport">
    <div id="life-zone" class="slot">Life</div>
    <div id="char-zone-front" class="flex-zone" data-label="Front Line"></div>
    <div id="drop-deck" class="slot card-back">Deck</div>
    
    <div id="stage-zone" class="flex-zone" data-label="Stage / Back Line"></div>
    <div id="leader-zone" class="slot active-zone">Leader</div>
    <div id="drop-trash" class="slot">Trash</div>
    
    <div id="don-deck" class="slot">DON!! Deck<br><span id="don-deck-count" style="font-size:24px;">10</span></div>
    <div id="don-zone" class="flex-zone" data-label="Cost Area"></div>
</div>

<div id="hand-bar"></div>
<div id="context-menu"></div>
<div id="zoom-overlay" onclick="this.style.display='none'"><img id="zoom-img" src=""></div>
<div id="inspector">
    <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
        <h2 id="insp-title" style="margin:0; color:var(--op-blue);">Inspector</h2>
        <button onclick="closeInspector()" style="background:#c0392b; padding:10px 30px;">CLOSE</button>
    </div>
    <div id="insp-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px;"></div>
</div>

<script>
    const DON_URL = 'https://tcgplayer-cdn.tcgplayer.com/product/456059_in_1000x1000.jpg';
    
    // ==========================================
    // CARD DATABASE
    // ==========================================
    const CARD_DB = {
        "https://i.imgur.com/llnj5xT.png": { name: "Franky", type: "Leader", traits: ["Straw Hat Pirates", "Cyborg", "Water Seven"], hasMain: true, hasEndTurn: true },
        "https://i.imgur.com/2lEVHJP.png": { name: "Franky (Character)", type: "Character", cost: 1, traits: ["Straw Hat Pirates", "Cyborg", "Water Seven"], hasOnPlay: true },
        "https://i.imgur.com/f6TtmW9.png": { name: "Franky Family", type: "Character", cost: 3, traits: ["Water Seven"], hasOnPlay: true },
        "https://i.imgur.com/bzg3Xpr.png": { name: "Chopper", type: "Character", cost: 5, traits: ["Straw Hat Pirates"], hasAttack: true },
        "https://i.imgur.com/zmZCFVB.png": { name: "General Franky", type: "Character", cost: 11, traits: ["Straw Hat Pirates", "Invention"], hasHandAction: true },
        "https://i.imgur.com/WCFtQ4V.png": { name: "Nami", type: "Character", cost: 1, traits: ["Straw Hat Crew"], hasOnPlay: true },
        "https://i.imgur.com/5LAj93m.png": { name: "Zoro-juurou", type: "Character", cost: 3, traits: ["Straw Hat Crew"], hasAttack: true },
        "https://i.imgur.com/XzXandk.png": { name: "Sanji & Pudding", type: "Character", cost: 5, traits: ["Straw Hat Crew"], hasOnPlay: true, hasAuto: true },
        "https://i.imgur.com/l16quan.png": { name: "Bon Clay", type: "Character", cost: 4, traits: ["Alabasta"], hasOnPlay: true },
        "https://i.imgur.com/gAedzn3.png": { name: "Gol D. Roger", type: "Character", cost: 8, traits: ["Roger Pirates"], hasOnPlay: true },
        "https://i.imgur.com/egPJ3rM.png": { name: "Uso-hatchi", type: "Character", cost: 3, traits: ["Straw Hat Pirates"] },
        
        // Stages
        "https://i.imgur.com/KdMSz8v.png": { name: "Mini Merry", type: "Stage", cost: 5, traits: ["Straw Hat Pirates", "Invention"], hasMain: true, hasOnRest: true },
        "https://i.imgur.com/oULaM8n.png": { name: "Waver", type: "Stage", cost: 5, traits: ["Straw Hat Pirates", "Invention"], hasMain: true, hasOnRest: true },
        "https://i.imgur.com/YRa5DDx.png": { name: "Brachio Tank V", type: "Stage", cost: 5, traits: ["Straw Hat Pirates", "Invention"], hasMain: true, hasOnPlay: true },
        "https://i.imgur.com/L3W1rAw.png": { name: "Kurosai Fr-U IV", type: "Stage", cost: 5, traits: ["Straw Hat Pirates", "Invention"], hasMain: true, hasOnPlay: true },
        "https://i.imgur.com/NAjePQD.png": { name: "Shark Submerge III", type: "Stage", cost: 5, traits: ["Straw Hat Pirates", "Invention"], hasMain: true, hasAuto: true },
        
        // Events
        "https://i.imgur.com/cdHtYcm.png": { name: "Event 1", type: "Event", cost: 0, traits: ["Straw Hat Crew"] },
        "https://i.imgur.com/A8Z5aKe.png": { name: "Event 2", type: "Event", cost: 0, traits: ["Straw Hat Crew"] }
    };

    const deckArray = [
        "https://i.imgur.com/llnj5xT.png", // Leader
        ...Array(4).fill("https://i.imgur.com/2lEVHJP.png"),
        ...Array(4).fill("https://i.imgur.com/f6TtmW9.png"),
        ...Array(4).fill("https://i.imgur.com/bzg3Xpr.png"),
        ...Array(2).fill("https://i.imgur.com/zmZCFVB.png"),
        ...Array(4).fill("https://i.imgur.com/WCFtQ4V.png"),
        ...Array(3).fill("https://i.imgur.com/5LAj93m.png"),
        ...Array(4).fill("https://i.imgur.com/XzXandk.png"),
        ...Array(4).fill("https://i.imgur.com/l16quan.png"),
        ...Array(3).fill("https://i.imgur.com/gAedzn3.png"),
        ...Array(2).fill("https://i.imgur.com/egPJ3rM.png"),
        ...Array(2).fill("https://i.imgur.com/KdMSz8v.png"),
        ...Array(2).fill("https://i.imgur.com/oULaM8n.png"),
        ...Array(2).fill("https://i.imgur.com/YRa5DDx.png"),
        ...Array(2).fill("https://i.imgur.com/L3W1rAw.png"),
        ...Array(2).fill("https://i.imgur.com/NAjePQD.png"),
        ...Array(3).fill("https://i.imgur.com/cdHtYcm.png"),
        ...Array(3).fill("https://i.imgur.com/A8Z5aKe.png")
    ];

    let DECK_ARR = [], TRASH_ARR = [], turnNum = 0, DON_DECK_COUNT = 10, OPP_DON = 0, isFirst = true;
    let dragged = null, hovered = null, rightClickedCard = null;
    let cardIDCounter = 0, isDragging = false, offX, offY, startX, startY;
    let historyStack = [], historyIndex = -1, selectConfig = null, SEARCH_ARR = [];

    window.onload = () => {
        document.getElementById('deck-list').innerHTML = `<div style="padding:10px; background:#222; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;"><b>Franky Pro Deck</b> <button onclick="initGame()">PLAY</button></div>`;
    };

    // ==========================================
    // INITIALIZATION
    // ==========================================
    function initGame() {
        document.getElementById('home-screen').style.display='none';
        isFirst = (prompt("Are you going First or Second? (Type '1' for First, '2' for Second)", "1") === "1");

        DECK_ARR = deckArray.slice(1);
        shuffleArray(DECK_ARR);
        
        createCard(deckArray[0], 0, 0, {zone:'leader-zone'}); 
        for(let i=0; i<5; i++) deckToLife(true);
        for(let i=0; i<5; i++) drawCard(true);

        setTimeout(() => {
            if(confirm("Mulligan? (Return hand to deck, shuffle, and draw 5 new cards)")) {
                document.querySelectorAll('#hand-bar .card').forEach(c => { DECK_ARR.unshift(c.dataset.url); c.remove(); });
                shuffleArray(DECK_ARR);
                for(let i=0; i<5; i++) drawCard(true);
            }
            startFirstTurn();
            saveState();
        }, 500);
    }

    function startFirstTurn() {
        turnNum = 1;
        if(isFirst) { OPP_DON = 0; spawnDonAction(); } 
        else { OPP_DON = 1; spawnDonAction(); spawnDonAction(); }
        alert(`Turn 1 Start! You are going ${isFirst ? 'First' : 'Second'}.`);
    }

    window.resetOncePerGame = function() {
        document.body.dataset.merryUsed = "false";
        alert("All Once Per Game effects have been reset.");
    };

    // ==========================================
    // STATE MACHINE
    // ==========================================
    function saveState() {
        if (historyIndex < historyStack.length - 1) historyStack = historyStack.slice(0, historyIndex + 1);
        const field = Array.from(document.querySelectorAll('#viewport .card:not(#drop-deck):not(#don-deck)')).map(c => ({
            id: c.id, url: c.dataset.url, zone: c.parentElement.id, isDon: c.dataset.isDon, isLife: c.dataset.isLife, parentId: c.dataset.parentId,
            rested: c.classList.contains('rested'), back: c.classList.contains('card-back'), power: c.querySelector('.power-badge').innerText, pVis: c.querySelector('.power-badge').style.display, rush: c.querySelector('.rush-tag').style.display, spUsed: c.dataset.spUsed, turnPlayed: c.dataset.turnPlayed
        }));
        const hand = Array.from(document.querySelectorAll('#hand-bar .card')).map(c => ({ url: c.dataset.url, id: c.id }));
        historyStack.push({ deck: [...DECK_ARR], trash: [...TRASH_ARR], don: DON_DECK_COUNT, opp: OPP_DON, field, hand, counter: cardIDCounter, turn: turnNum });
        historyIndex++; refreshStats();
    }

    function undoState() { if(historyIndex > 0) { historyIndex--; restoreState(historyStack[historyIndex]); } }
    function redoState() { if(historyIndex < historyStack.length-1) { historyIndex++; restoreState(historyStack[historyIndex]); } }
    function restoreState(s) {
        document.querySelectorAll('.card').forEach(c => c.remove());
        DECK_ARR = [...s.deck]; TRASH_ARR = [...s.trash]; DON_DECK_COUNT = s.don; OPP_DON = s.opp; cardIDCounter = s.counter; turnNum = s.turn;
        s.hand.forEach(d => createCard(d.url, 0, 0, {inHand: true, id: d.id}));
        s.field.forEach(d => {
            const c = createCard(d.url, 0, 0, {zone: d.zone, isLife: d.isLife==="true", isBack: d.back, id: d.id});
            if(d.isLife === "true") c.style.position = 'absolute';
            if(d.rested) c.classList.add('rested'); if(d.parentId) c.dataset.parentId = d.parentId; if(d.spUsed) c.dataset.spUsed = d.spUsed; if(d.turnPlayed) c.dataset.turnPlayed = d.turnPlayed;
            c.querySelector('.power-badge').innerText = d.power; c.querySelector('.power-badge').style.display = d.pVis; c.querySelector('.rush-tag').style.display = d.rush;
        });
        organizeDon(); updateLifePositions(); refreshStats();
    }

    // ==========================================
    // UI & DRAG LOGIC
    // ==========================================
    window.addEventListener('mousedown', (e) => { if(!e.target.closest('#context-menu') && !e.target.closest('#inspector')) hideMenu(); });
    function hideMenu() { document.getElementById('context-menu').style.display = 'none'; }
    
    document.getElementById('drop-deck').onclick = () => drawCardAction();
    document.getElementById('drop-deck').oncontextmenu = (e) => {
        e.preventDefault(); if(DECK_ARR.length === 0) return;
        const menu = document.getElementById('context-menu');
        menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
        menu.innerHTML = `<div onclick="drawCardAction(); hideMenu();">Draw 1 Card</div><div onclick="let v=parseInt(prompt('Search Top X?','5')); if(v) openSearch(v); hideMenu();">Search Top X</div><div onclick="openInspector('deck'); hideMenu();">View Entire Deck</div>`;
    };
    document.getElementById('drop-trash').onclick = () => { if(TRASH_ARR.length) openInspector('trash'); };
    document.getElementById('drop-trash').oncontextmenu = (e) => { e.preventDefault(); if(TRASH_ARR.length) openInspector('trash'); };

    window.addEventListener('mousemove', (e) => {
        if (!dragged || selectConfig) return;
        if(!isDragging && (Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5)) {
            isDragging = true;
            if(dragged.parentElement.id !== 'viewport') { document.getElementById('viewport').appendChild(dragged); dragged.style.position = 'absolute'; }
        }
        if(isDragging) { 
            dragged.style.left = (e.clientX - offX - 280) + 'px'; dragged.style.top = (e.clientY - offY) + 'px'; dragged.style.zIndex = 5000; 
            document.querySelectorAll(`[data-parent-id="${dragged.id}"]`).forEach((don, i) => { don.style.left = (e.clientX - offX - 280 + 10) + 'px'; don.style.top = (e.clientY - offY - 20 - (i * 12)) + 'px'; don.style.zIndex = "4900"; });
        }
    });

    window.addEventListener('mouseup', (e) => {
        if (!dragged || selectConfig) return;
        const c = dragged; dragged = null; 
        if(!isDragging) { if(c.parentElement.id === 'hand-bar') playCardConfirm(c); return; }

        saveState(); c.style.zIndex = 20;
        const trashR = document.getElementById('drop-trash').getBoundingClientRect();
        const handR = document.getElementById('hand-bar').getBoundingClientRect();
        const deckR = document.getElementById('drop-deck').getBoundingClientRect();
        const lifeR = document.getElementById('life-zone').getBoundingClientRect();

        if (isInside(e, trashR)) { moveToTrash(c); }
        else if (isInside(e, handR)) { toHand(c); }
        else if (isInside(e, deckR)) { DECK_ARR.unshift(c.dataset.url); deleteCardData(c); c.remove(); }
        else if (isInside(e, lifeR)) { dropToLife(c); }
        else if (c.dataset.isDon === "true") {
            const target = Array.from(document.elementsFromPoint(e.clientX, e.clientY)).find(el => el.classList.contains('card') && el !== c && (CARD_DB[el.dataset.url]?.type === 'Character' || CARD_DB[el.dataset.url]?.type === 'Leader'));
            if (target && !['hand-bar', 'life-zone'].includes(target.parentElement.id)) { c.dataset.parentId = target.id; updateBadges(target.id); }
            organizeDon();
        } else {
            const orig = document.getElementById(c.dataset.origZone);
            if(orig) { 
                orig.appendChild(c); c.style.position = (orig.id === 'life-zone') ? 'absolute' : 'relative'; c.style.left = '0'; c.style.top = '0'; 
                if(orig.id === 'life-zone') updateLifePositions(); 
            }
        }
        refreshStats();
    });

    function isInside(e, r) { return e.clientX > r.left && e.clientX < r.right && e.clientY > r.top && e.clientY < r.bottom; }

    function createCard(url, x, y, opts = {}) {
        const c = document.createElement('div'); c.className = 'card'; c.id = opts.id || 'c-' + cardIDCounter++;
        c.dataset.url = url; c.dataset.isDon = (url === DON_URL).toString(); c.dataset.isLife = (opts.isLife || false).toString();
        c.style.backgroundImage = `url('${url}')`; c.innerHTML = `<div class="don-badge">0</div><div class="power-badge">+0</div><div class="rush-tag">RUSH</div>`;
        if (opts.isBack) c.classList.add('card-back');
        bindCardEvents(c);
        if (opts.inHand) document.getElementById('hand-bar').appendChild(c);
        else if (opts.zone) document.getElementById(opts.zone).appendChild(c);
        return c;
    }

    function bindCardEvents(c) {
        c.onmousedown = (e) => {
            if (e.button !== 0) return;
            if (selectConfig) { handleSelection(c); return; }
            const locked = ['leader-zone', 'char-zone-front', 'stage-zone'];
            if(locked.includes(c.parentElement.id) && c.dataset.isDon !== "true") return;
            offX = e.clientX - c.getBoundingClientRect().left; offY = e.clientY - c.getBoundingClientRect().top; startX = e.clientX; startY = e.clientY; dragged = c; isDragging = false; c.dataset.origZone = c.parentElement.id;
        };
        
        // Inspect with Middle Click
        c.onauxclick = (e) => {
            if (e.button === 1) { e.preventDefault(); document.getElementById('zoom-img').src = c.dataset.url; document.getElementById('zoom-overlay').style.display = 'flex'; }
        };

        c.oncontextmenu = (e) => {
            e.preventDefault(); if(selectConfig) return; rightClickedCard = c; const db = CARD_DB[c.dataset.url]; const menu = document.getElementById('context-menu');
            menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px';
            
            let h = `<div onclick="document.getElementById('zoom-img').src='${c.dataset.url}'; document.getElementById('zoom-overlay').style.display='flex'; hideMenu();">üîç Inspect Card</div>`;
            h += `<div onclick="setPower(1000)">+1000 Power</div><div onclick="setPower(0)">Reset Power</div>`;
            
            if (db?.hasMain && !['hand-bar', 'life-zone'].includes(c.parentElement.id)) h += `<div onclick="activateMain()" style="background:#f39c12; color:000">Activate Main</div>`;
            
            // Summoning Sickness Check
            if (db?.hasAttack && !['hand-bar', 'life-zone'].includes(c.parentElement.id)) {
                const isSick = (c.dataset.turnPlayed == turnNum) && (c.querySelector('.rush-tag').style.display !== 'flex');
                if(!isSick) h += `<div onclick="simulateAttack()" style="background:#c0392b; color:fff">Attack</div>`;
                else h += `<div style="background:#555; color:#999; cursor:not-allowed;" title="Summoning Sickness">Attack (Sleeping)</div>`;
            }

            if (c.dataset.isLife === "true") h += `<div onclick="flipLife()">Flip Life</div><div onclick="takeLife()">Take to Hand</div>`;
            if (c.parentElement.id === 'hand-bar' && db?.hasHandAction) h += `<div onclick="gfAction()" style="background:#3498db; color:fff">Bot Deck & Draw</div>`;
            if (c.parentElement.id !== 'hand-bar' && c.parentElement.id !== 'life-zone' && c.parentElement.id !== 'leader-zone') h += `<div onclick="moveToTrash(rightClickedCard)" style="color:#e67e22">Trash</div>`;
            h += `<div onclick="detachDon()">Detach DON!!</div>`;
            menu.innerHTML = h;
        };
        c.onmouseenter = () => hovered = c; c.onmouseleave = () => hovered = null;
    }

    // ==========================================
    // LOGIC & EFFECTS
    // ==========================================
    function playCardConfirm(c) {
        const db = CARD_DB[c.dataset.url]; if(!db) return;
        if(db.cost > 10) { alert("Unplayable cost!"); return; }
        if(confirm(`Play ${db.name} for ${db.cost} DON!!?`)) { rightClickedCard = c; window.playCard(); }
    }

    window.playCard = function(isFree = false) {
        const c = rightClickedCard; const db = CARD_DB[c.dataset.url]; hideMenu();
        const activeDons = Array.from(document.querySelectorAll('#don-zone .card[data-is-don="true"]:not(.rested)')).filter(d => !d.dataset.parentId);
        if(!isFree && activeDons.length < db.cost) { alert(`Need ${db.cost} active DON!!`); return; }

        if (db.type === 'Character') {
            const chars = Array.from(document.querySelectorAll('#char-zone-front .card, #stage-zone .card')).filter(el => CARD_DB[el.dataset.url]?.type === 'Character');
            if (chars.length >= 5) { startSelection('replace_char', 1, "Select Character to Replace", () => { executePlay(c, db, isFree, activeDons); }); return; }
        } else if (db.type === 'Stage') {
            const limit = document.querySelector('#leader-zone .card')?.dataset.url.includes("llnj5xT") ? 5 : 1;
            const stages = Array.from(document.querySelectorAll('#stage-zone .card')).filter(el => CARD_DB[el.dataset.url]?.type === 'Stage');
            if (stages.length >= limit) { startSelection('replace_stage', 1, "Select Stage to Replace", () => { executePlay(c, db, isFree, activeDons); }); return; }
        }
        executePlay(c, db, isFree, activeDons);
    }

    function executePlay(c, db, isFree, activeDons) {
        saveState();
        if(!isFree) { for(let i=0; i<db.cost; i++) activeDons[i].classList.add('rested'); }
        
        c.classList.remove('card-back'); c.dataset.isLife = "false"; 
        c.style.position = 'relative'; c.style.left = '0'; c.style.top = '0'; 
        c.dataset.turnPlayed = turnNum; // Mark for summoning sickness

        if(db.type === 'Stage') { document.getElementById('stage-zone').appendChild(c); } 
        else {
            const fz = document.getElementById('char-zone-front'); const bz = document.getElementById('stage-zone');
            if(fz.children.length < 5) fz.appendChild(c); else bz.appendChild(c);
        }
        refreshStats();
        setTimeout(() => triggerOnPlay(c, db), 100);
    }

    function triggerOnPlay(cardEl, db) {
        const hasLogic = ["Franky (Character)", "Franky Family", "Nami", "Sanji & Pudding", "Bon Clay", "Gol D. Roger", "Brachio Tank V", "Kurosai Fr-U IV"].includes(db.name) && (db.hasOnPlay || db.type === 'Character');
        if (!hasLogic && !db.hasOnPlay) return;

        if(!confirm(`Activate On Play effect of ${db.name}?`)) return;

        if(db.name === "Franky (Character)") {
            const stages = Array.from(document.querySelectorAll('#stage-zone .card:not(.rested)')).filter(s => CARD_DB[s.dataset.url]?.traits?.includes("Invention"));
            if(stages.length > 0) { startSelection('rest_stage', 1, "Select Invention Stage to Rest", () => {}); } 
            else { alert("No active Invention stages found!"); }
        }
        if(db.name === "Franky Family") { 
            if(document.querySelectorAll('#hand-bar .card').length === 0) { alert("No cards in hand to trash."); return; }
            if(DON_DECK_COUNT <= 0) { alert("No DON!! left in deck."); return; }
            startSelection('trash_hand_for_don', 1, "Select card in hand to trash", () => rampDon(true)); 
        }
        if(db.name === "Nami") { openSearch(5, ["Straw Hat Crew", "Straw Hat Pirates"]); }
        if(db.name === "Sanji & Pudding") { if(document.querySelectorAll('#don-zone .card[data-is-don="true"]').length <= OPP_DON) drawCardAction(); }
        if(db.name === "Bon Clay") { rampDon(false); }
        if(db.name === "Gol D. Roger") { if(document.querySelectorAll('#don-zone .card[data-is-don="true"]').length >= 10 || OPP_DON >= 10) applyPower(document.querySelector('#leader-zone .card'), 2000); }
        if(db.name === "Brachio Tank V") { startSelection('give_rush', 1, "Select Character to give Rush", () => {}); }
        if(db.name === "Kurosai Fr-U IV") { startSelection('play_kurosai', 1, "Select Cost <=5 Straw Hat from Hand", () => {}); }
    }

    window.activateMain = function() {
        hideMenu(); const c = rightClickedCard; const db = CARD_DB[c.dataset.url];
        if(c.classList.contains('rested')) { alert("Card is rested."); return; }
        
        if(db.name === "Franky" && db.type === "Leader") {
            const handStages = Array.from(document.querySelectorAll('#hand-bar .card')).filter(h => CARD_DB[h.dataset.url]?.traits?.includes("Invention") && CARD_DB[h.dataset.url]?.type === "Stage");
            if(handStages.length === 0) { alert("You don't have an Invention Stage in your hand to play."); return; }
            
            startSelection('discard_don', 2, "Select 2 DON!! to Discard", () => {
                setTimeout(() => { startSelection('play_free_stage', 1, "Select Invention Stage to Play from Hand", () => {}); }, 100);
            });
        }
        
        if(db.type === "Stage" && db.traits?.includes("Invention")) {
            if(document.body.dataset.merryUsed === "true") { alert("Once Per Game effect already used!"); return; }
            const invs = Array.from(document.querySelectorAll('#stage-zone .card:not(.rested)')).filter(s => CARD_DB[s.dataset.url]?.traits?.includes("Invention"));
            
            if(invs.length >= 5) {
                const idx = DECK_ARR.findIndex(u => CARD_DB[u]?.name === "General Franky");
                if (idx === -1) { alert("General Franky is not in your Deck! Effect cancelled."); return; }
                
                if(confirm("Rest 5 Invention Stages to search General Franky?")) {
                    saveState(); 
                    document.body.dataset.merryUsed = "true";
                    invs.slice(0,5).forEach(s => restCard(s)); 
                    createCard(DECK_ARR.splice(idx,1)[0], 0, 0, {zone: 'char-zone-front'});
                    refreshStats();
                }
            } else { 
                alert("Need 5 active Invention stages on field."); 
            }
        }
    };

    window.simulateAttack = function() {
        hideMenu(); const c = rightClickedCard; const db = CARD_DB[c.dataset.url]; saveState();
        if(db.name === "Chopper") {
            drawCardAction(); const hasBrachio = Array.from(document.querySelectorAll('#stage-zone .card')).some(s => CARD_DB[s.dataset.url]?.name === "Brachio Tank V");
            if(hasBrachio) applyPower(c, 2000);
        }
        if(db.name === "Zoro-juurou") { if(document.querySelectorAll('#life-zone .card').length <= 3) rampDon(false); }
        restCard(c);
    }
    
    window.gfAction = function() { hideMenu(); saveState(); DECK_ARR.unshift(rightClickedCard.dataset.url); rightClickedCard.remove(); drawCardAction(); refreshStats(); };

    function restCard(cardEl) {
        cardEl.classList.toggle('rested'); const db = CARD_DB[cardEl.dataset.url];
        if(db?.name === "Mini Merry" && cardEl.classList.contains('rested')) { if(confirm("Mini Merry rested: Draw 1?")) drawCardAction(); }
        if(db?.name === "Waver" && cardEl.classList.contains('rested')) rampDon(true);
    }

    // ==========================================
    // SELECTION SYSTEM
    // ==========================================
    function startSelection(mode, max, message, callback, onCancel = null) { 
        selectConfig = { mode, max, current: [], callback, onCancel }; 
        document.body.classList.add('select-mode'); 
        document.getElementById('select-overlay').style.display = 'block'; 
        document.getElementById('select-msg').style.display = 'flex'; 
        document.getElementById('select-text').innerText = message + ` (0/${max})`; 
    }
    
    function cancelSelection() {
        document.body.classList.remove('select-mode'); document.getElementById('select-overlay').style.display = 'none'; document.getElementById('select-msg').style.display = 'none';
        document.querySelectorAll('.card').forEach(c => c.style.outline = "");
        if(selectConfig?.onCancel) selectConfig.onCancel();
        selectConfig = null;
    }

    function handleSelection(card) {
        const mode = selectConfig.mode;
        if(mode === 'discard_don' && card.dataset.isDon !== "true") return;
        if((mode === 'trash_hand' || mode === 'trash_hand_for_don') && card.parentElement.id !== 'hand-bar') return;
        if(mode === 'give_rush' && CARD_DB[card.dataset.url]?.type !== "Character") return;
        if((mode === 'replace_char' || mode === 'trash_char') && !['char-zone-front', 'stage-zone'].includes(card.parentElement.id)) return;
        if(mode === 'replace_stage' && card.parentElement.id !== 'stage-zone') return;
        if(mode === 'rest_stage') { if(card.parentElement.id !== 'stage-zone' || !CARD_DB[card.dataset.url]?.traits?.includes("Invention") || card.classList.contains('rested')) { alert("Must select an active Invention stage."); return; } }
        if(mode === 'play_free_stage') { if(card.parentElement.id !== 'hand-bar' || CARD_DB[card.dataset.url]?.type !== "Stage" || !CARD_DB[card.dataset.url]?.traits?.includes("Invention")) { alert("Must select Invention Stage from hand."); return; } }
        if(mode === 'play_kurosai') { if(card.parentElement.id !== 'hand-bar' || CARD_DB[card.dataset.url]?.type !== "Character" || CARD_DB[card.dataset.url]?.cost > 5 || (!CARD_DB[card.dataset.url]?.traits?.includes("Straw Hat Pirates") && !CARD_DB[card.dataset.url]?.traits?.includes("Straw Hat Crew"))) { alert("Must be Cost <= 5 Straw Hat Character from hand."); return; } }

        selectConfig.current.push(card); card.style.outline = "4px solid #e74c3c";
        document.getElementById('select-text').innerText = `Selected (${selectConfig.current.length}/${selectConfig.max})`;
        
        if(selectConfig.current.length >= selectConfig.max) {
            const completed = [...selectConfig.current];
            
            if(mode === 'discard_don') { 
                completed.forEach(d => { delete d.dataset.parentId; d.remove(); DON_DECK_COUNT++; }); 
                organizeDon(); 
                const spChars = Array.from(document.querySelectorAll('#char-zone-front .card, #stage-zone .card')).filter(c => CARD_DB[c.dataset.url]?.name === "Sanji & Pudding" && c.dataset.spUsed !== "true");
                spChars.forEach(sp => { if(confirm("Activate Sanji & Pudding to add 1 active DON!!?")) { rampDon(false); sp.dataset.spUsed = "true"; } });
            }
            if(mode === 'trash_hand' || mode === 'trash_hand_for_don' || mode === 'trash_char' || mode === 'replace_char' || mode === 'replace_stage') moveToTrash(completed[0]);
            if(mode === 'give_rush') { completed[0].querySelector('.rush-tag').style.display = 'flex'; }
            if(mode === 'rest_stage') { restCard(completed[0]); }
            
            document.body.classList.remove('select-mode'); document.getElementById('select-overlay').style.display = 'none'; document.getElementById('select-msg').style.display = 'none';
            document.querySelectorAll('.card').forEach(c => c.style.outline = "");
            
            const cb = selectConfig.callback; selectConfig = null; 
            
            if(mode === 'play_free_stage' || mode === 'play_kurosai') { rightClickedCard = completed[0]; window.playCard(true); }
            if(cb) cb(); refreshStats();
        }
    }

    // ==========================================
    // INSPECTOR & SEARCH
    // ==========================================
    function openInspector(mode) {
        const list = (mode==='deck') ? [...DECK_ARR].reverse() : [...TRASH_ARR];
        document.getElementById('insp-title').innerText = mode.toUpperCase() + " VIEW";
        const grid = document.getElementById('insp-grid'); grid.innerHTML = '';
        list.forEach((url, i) => {
            const img = document.createElement('div'); img.style.height='220px'; img.style.width='157px'; img.style.backgroundImage=`url('${url}')`; img.style.backgroundSize='100% 100%'; img.style.borderRadius='8px'; img.style.cursor='pointer';
            img.onclick = () => { saveState(); if(mode==='deck') DECK_ARR.splice(DECK_ARR.length-1-i, 1); else TRASH_ARR.splice(i, 1); createCard(url, 0, 0, {inHand: true}); closeInspector(); };
            grid.appendChild(img);
        });
        document.getElementById('inspector').style.display = 'block';
    }

    function openSearch(val, filterTraits = null) {
        SEARCH_ARR = DECK_ARR.splice(-val).reverse();
        const grid = document.getElementById('insp-grid'); grid.innerHTML = '';
        document.getElementById('insp-title').innerText = filterTraits ? `Searching Top ${SEARCH_ARR.length}` : `Looking at Top ${SEARCH_ARR.length}`;
        
        SEARCH_ARR.forEach((url, i) => {
            const cardTraits = CARD_DB[url]?.traits || [];
            let canTake = true;
            if (filterTraits) { canTake = filterTraits.some(t => cardTraits.includes(t)); }
            
            const div = document.createElement('div'); div.style.textAlign = 'center';
            div.innerHTML = `
                <div style="width:157px; height:220px; background-image:url('${url}'); background-size:100% 100%; border-radius:8px; border: ${canTake && filterTraits ? '4px solid #2ecc71' : 'none'}"></div>
                <div style="display:flex; gap:2px; margin-top:5px;">
                    ${canTake ? `<button onclick="resolveSearch(${i},'hand')" style="flex:1; font-size:10px;">HAND</button>` : ''}
                    <button onclick="resolveSearch(${i},'bot')" style="flex:1; font-size:10px; background:#333">BOT</button>
                    <button onclick="resolveSearch(${i},'trash')" style="flex:1; font-size:10px; background:#c0392b">TRASH</button>
                </div>`;
            grid.appendChild(div);
        });
        document.getElementById('inspector').style.display = 'block';
    }

    function resolveSearch(i, type) {
        saveState(); const url = SEARCH_ARR.splice(i, 1)[0];
        if(type === 'hand') createCard(url, 0, 0, {inHand:true});
        else if(type === 'trash') TRASH_ARR.push(url);
        else DECK_ARR.unshift(url);
        
        if(!SEARCH_ARR.length) closeInspector(); 
        else { const remaining = document.getElementById('insp-grid').children; remaining[i].style.display = 'none'; }
        refreshStats();
    }
    
    function closeInspector() { 
        while(SEARCH_ARR.length) DECK_ARR.push(SEARCH_ARR.pop()); 
        document.getElementById('inspector').style.display = 'none'; 
        document.body.classList.remove('select-mode'); selectConfig = null; refreshStats(); 
    }

    // ==========================================
    // UTILITIES & BUTTON BINDINGS
    // ==========================================
    function endTurn() {
        const leader = document.querySelector('#leader-zone .card');
        if(leader && leader.dataset.url.includes("llnj5xT")) {
            if(DECK_ARR.length >= 5) openSearch(5, ["Straw Hat Pirates", "Straw Hat Crew"]);
        }
        
        setTimeout(() => {
            saveState(); turnNum++; OPP_DON = Math.min(10, OPP_DON + 2);
            document.querySelectorAll('.card').forEach(c => { 
                const db = CARD_DB[c.dataset.url];
                if(db?.name === "Shark Submerge III" && c.classList.contains('rested')) {
                    const restedDons = Array.from(document.querySelectorAll('#don-zone .card[data-is-don="true"].rested'));
                    for(let i=0; i<Math.min(2, restedDons.length); i++) restedDons[i].classList.remove('rested');
                }
                c.classList.remove('rested'); delete c.dataset.parentId; delete c.dataset.spUsed;
                if(c.querySelector('.don-badge')) c.querySelector('.don-badge').style.display = 'none';
                if(c.querySelector('.rush-tag')) c.querySelector('.rush-tag').style.display = 'none';
                if(c.querySelector('.power-badge')) { c.querySelector('.power-badge').innerText = '+0'; c.querySelector('.power-badge').style.display = 'none'; }
            });
            spawnDonAction(); spawnDonAction(); drawCardAction(); organizeDon(); refreshStats();
        }, 800);
    }

    window.moveToTrash = function(c) { deleteCardData(c); TRASH_ARR.push(c.dataset.url); c.remove(); refreshStats(); hideMenu(); }
    window.flipLife = function() { rightClickedCard.classList.toggle('card-back'); hideMenu(); };
    window.takeLife = function() { saveState(); toHand(rightClickedCard); hideMenu(); };
    function toHand(c) { c.dataset.isLife = "false"; c.classList.remove('card-back', 'rested'); c.style.position='relative'; document.getElementById('hand-bar').appendChild(c); deleteCardData(c); updateLifePositions(); }
    function dropToLife(c) { 
        const s = prompt("Place card at Top or Bottom of Life? (t/b)", "t"); if(!s) return; 
        c.dataset.isLife = "true"; c.classList.add('card-back'); c.style.position = 'absolute';
        const z = document.getElementById('life-zone'); if(s.toLowerCase().startsWith("b")) z.prepend(c); else z.appendChild(c); 
        updateLifePositions(); 
    }
    function deleteCardData(c) { document.querySelectorAll(`[data-parent-id="${c.id}"]`).forEach(d => { delete d.dataset.parentId; }); organizeDon(); }

    function updateLifePositions() {
        const lifeCards = Array.from(document.getElementById('life-zone').children).filter(c => c.classList.contains('card'));
        lifeCards.forEach((c, i) => { c.style.left = '0px'; c.style.top = (i * 35) + 'px'; c.style.zIndex = 20 + i; });
        refreshStats();
    }

    function organizeDon() {
        const vr = document.getElementById('viewport').getBoundingClientRect();
        document.querySelectorAll('#viewport .card[data-is-don="true"]').forEach(d => {
            if(d.dataset.parentId) {
                const p = document.getElementById(d.dataset.parentId); if(p) { const r = p.getBoundingClientRect(); d.style.position='absolute'; d.style.left=(r.left-vr.left+10)+'px'; d.style.top=(r.top-vr.top-15)+'px'; d.style.zIndex="15"; d.style.opacity="0.5"; }
            } else { document.getElementById('don-zone').appendChild(d); d.style.opacity = "1"; d.style.position="relative"; d.style.left="0"; d.style.top="0";}
        });
    }

    function rampDon(isRested) { if(DON_DECK_COUNT > 0 && document.querySelectorAll('.card[data-is-don="true"]').length < 10) { DON_DECK_COUNT--; const d = createCard(DON_URL,0,0,{zone:'don-zone'}); if(isRested) d.classList.add('rested'); organizeDon(); refreshStats(); } }
    
    // Explicit Window bindings for buttons to prevent DOM issues
    window.spawnDonAction = function() { rampDon(false); };
    window.spawnDon = function() { saveState(); spawnDonAction(); };
    window.killDon = function() { saveState(); const d = Array.from(document.querySelectorAll('.card[data-is-don="true"]')).find(c=>!c.dataset.parentId); if(d) { d.remove(); DON_DECK_COUNT++; refreshStats(); } };
    window.drawCardAction = function() { if(DECK_ARR.length) createCard(DECK_ARR.pop(),0,0,{inHand:true}); refreshStats(); };
    function drawCard(skipSave) { if(!skipSave) saveState(); drawCardAction(); }
    window.deckToLife = function() { saveState(); if(DECK_ARR.length) { const c = createCard(DECK_ARR.pop(),0,0,{isLife:true, isBack:true}); c.style.position = 'absolute'; document.getElementById('life-zone').appendChild(c); updateLifePositions(); } };
    
    function refreshStats() { document.getElementById('deck-count').innerText=DECK_ARR.length; document.getElementById('trash-count').innerText=TRASH_ARR.length; document.getElementById('life-count').innerText=document.querySelectorAll('#life-zone .card').length; document.getElementById('don-deck-count').innerText=DON_DECK_COUNT; document.getElementById('opp-don').innerText=OPP_DON; }
    function shuffleArray(a) { for(let i=a.length-1; i>0; i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; }}
    
    window.onkeydown=(e)=>{ if(e.key.toLowerCase()==='r'&&hovered) { saveState(); restCard(hovered); } };
    
    window.setPower=(v)=>{ 
        const p = rightClickedCard.querySelector('.power-badge'); 
        if(v === 0) { p.innerText='+0'; p.style.display='none'; } 
        else { const cur = parseInt(p.innerText.replace('+','')); p.innerText=`+${cur+v}`; p.style.display='flex'; } 
        hideMenu(); 
    };
    function applyPower(c,v){ const p=c.querySelector('.power-badge'); const cur=parseInt(p.innerText.replace('+','')); p.innerText=`+${cur+v}`; p.style.display='flex'; }
    window.detachDon=()=>{ saveState(); document.querySelectorAll(`[data-parent-id="${rightClickedCard.id}"]`).forEach(d=>delete d.dataset.parentId); updateBadges(rightClickedCard.id); organizeDon(); hideMenu(); };
    function updateBadges(id){ const t = document.getElementById(id); if (!t) return; const c = document.querySelectorAll(`[data-parent-id="${id}"]`).length; const b = t.querySelector('.don-badge'); b.innerText = c; b.style.display = c > 0 ? 'flex' : 'none'; }
</script>
</body>
</html>